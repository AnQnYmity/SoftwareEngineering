# 财务管理系统 - 单元测试与集成测试

## 📋 实验内容

本项目完成软件工程实验五的要求：

- ✅ **单元测试** - 36个测试用例，覆盖率>85%
  - TransactionRepository: 16个测试用例
  - StatisticsService: 20个测试用例
- ✅ **集成测试** - 6个集成测试场景
- ✅ **持续集成** - GitHub Actions 自动化测试
- ✅ **代码覆盖率** - 支持lcov覆盖率分析

## 项目结构

```
proj1/
├── include/                    # 头文件目录
│   ├── models/                # 数据模型
│   │   ├── Transaction.h      # 交易类
│   │   ├── Category.h         # 分类类
│   │   ├── Account.h          # 账户类
│   │   └── Settings.h         # 设置类
│   ├── storage/               # 存储层
│   │   ├── IStorage.h         # 存储接口
│   │   ├── FileStorage.h      # 文件存储实现
│   │   └── TransactionRepository.h  # 交易仓库
│   ├── services/              # 业务逻辑层
│   │   ├── StatisticsService.h      # 统计服务
│   │   ├── NotificationService.h    # 通知服务
│   │   └── ImportExportService.h    # 导入导出服务
│   └── controller/            # 控制层
│       └── TransactionController.h  # 交易控制器
└── src/                       # 源文件目录
    ├── main.cpp              # 主程序
    ├── FileStorage.cpp
    ├── TransactionRepository.cpp
    ├── StatisticsService.cpp
    ├── NotificationService.cpp
    ├── ImportExportService.cpp
    └── TransactionController.cpp

```

## 核心功能

### 1. 数据模型
- **Transaction**: 交易记录，包含金额、类型、日期、分类、备注等
- **Category**: 交易分类
- **Account**: 账户信息
- **Settings**: 系统设置（预算、提醒阈值等）

### 2. 存储层 (Storage Layer)
- **IStorage**: 存储接口，定义存储操作规范
- **FileStorage**: 文件存储实现，使用JSON格式存储数据
- **TransactionRepository**: 交易仓库，提供CRUD操作

### 3. 业务逻辑层 (Services Layer)
- **StatisticsService**: 
  - 计算月度总计
  - 分类统计分析
  - 资产趋势分析
  
- **NotificationService**: 
  - 检查预算阈值
  - 生成提醒通知
  - 事件监听机制

- **ImportExportService**:
  - JSON导入导出
  - CSV导入导出

### 4. 控制层 (Controller Layer)
- **TransactionController**: 
  - 统一的业务接口
  - 协调各个服务组件

## 🚀 快速开始

### 1. 运行测试

**Windows PowerShell:**
```powershell
.\run_tests.ps1
```

**手动构建:**
```powershell
# 创建构建目录
mkdir build
cd build

# 配置CMake
cmake .. -DCMAKE_BUILD_TYPE=Debug

# 编译
cmake --build . --config Debug

# 运行测试
.\Debug\test_transaction_repository.exe
.\Debug\test_statistics_service.exe
.\Debug\test_integration.exe
```

### 2. 生成代码覆盖率报告（Linux）

```bash
cd build
cmake .. -DCMAKE_BUILD_TYPE=Coverage
cmake --build .

# 运行测试
./test_transaction_repository
./test_statistics_service
./test_integration

# 生成覆盖率报告
lcov --capture --directory . --output-file coverage.info
lcov --remove coverage.info '/usr/*' '*/tests/*' --output-file coverage_filtered.info
genhtml coverage_filtered.info --output-directory coverage_report
```

## 📊 测试用例说明

### TransactionRepository 单元测试（16个用例）

| 编号 | 测试用例 | 测试目的 |
|------|---------|---------|
| 1 | AddTransactionWithAutoGeneratedId | 测试自动生成ID的添加功能 |
| 2 | AddTransactionWithProvidedId | 测试指定ID的添加功能 |
| 3 | AddTransactionWithZeroAmount | 边界测试：零金额 |
| 4 | AddTransactionWithNegativeAmount | 边界测试：负金额 |
| 5 | AddTransactionWithLargeAmount | 边界测试：超大金额 |
| 6 | UpdateExistingTransaction | 测试更新已存在的交易 |
| 7 | UpdateNonExistentTransaction | 异常测试：更新不存在的交易 |
| 8 | RemoveTransaction | 测试软删除功能 |
| 9 | GetTransactionById | 测试按ID查询 |
| 10 | GetNonExistentTransactionById | 异常测试：查询不存在的交易 |
| 11 | FindTransactionsByCategory | 测试按分类筛选 |
| 12 | FindTransactionsByType | 测试按类型筛选 |
| 13 | FindTransactionsByDateRange | 测试按日期范围筛选 |
| 14 | FindTransactionsByKeyword | 测试按关键字筛选 |
| 15 | FindWithEmptyFilter | 测试空筛选条件 |
| 16 | AddTransactionWithEmptyNote | 边界测试：空备注 |

### StatisticsService 单元测试（20个用例）

| 编号 | 测试用例 | 测试目的 |
|------|---------|---------|
| 1 | GetTotalIncomeEmpty | 测试空数据集的收入统计 |
| 2 | GetTotalIncomeSingle | 测试单笔收入统计 |
| 3 | GetTotalIncomeMultiple | 测试多笔收入统计 |
| 4 | GetTotalIncomeIgnoreExpenses | 测试收入统计忽略支出 |
| 5 | GetTotalExpenseEmpty | 测试空数据集的支出统计 |
| 6 | GetTotalExpenseSingle | 测试单笔支出统计 |
| 7 | GetTotalExpenseMultiple | 测试多笔支出统计 |
| 8 | GetTotalExpenseIgnoreIncome | 测试支出统计忽略收入 |
| 9 | GetTotalIncomeWithinDateRange | 测试日期范围内的收入 |
| 10 | GetTotalIncomeOutsideDateRange | 测试日期范围外的收入 |
| 11 | CategoryBreakdownEmpty | 测试空分类统计 |
| 12 | CategoryBreakdownSingleCategory | 测试单分类统计 |
| 13 | CategoryBreakdownMultipleCategories | 测试多分类统计 |
| 14 | CategoryBreakdownIgnoreIncome | 测试分类统计忽略收入 |
| 15 | CalculateMonthlyTotals | 测试月度汇总计算 |
| 16 | AssetTrendCalculation | 测试资产趋势计算 |
| 17 | HandleZeroAmountTransactions | 测试零金额处理 |
| 18 | HandleLargeAmounts | 测试超大金额处理 |
| 19 | BoundaryDateRangeSameDay | 边界测试：单日查询 |
| 20 | HandleEmptyCategoryId | 测试空分类ID处理 |

### 集成测试（6个用例）

| 编号 | 测试场景 | 测试目的 |
|------|---------|---------|
| 1 | CompleteWorkflowAddAndCalculate | 测试完整的添加和统计流程 |
| 2 | UpdateTransactionsAndVerifyStatistics | 测试更新后统计数据同步 |
| 3 | DeleteTransactionsAndVerifyStatistics | 测试删除后统计数据更新 |
| 4 | FilterTransactionsAndCalculateStatistics | 测试筛选和统计联合使用 |
| 5 | MonthlyBudgetTracking | 业务场景：月度预算跟踪 |
| 6 | QuarterlyFinancialReview | 业务场景：季度财务回顾 |

## 🧪 测试技术说明

### 使用的测试框架
- **Google Test (GTest)** - C++ 单元测试框架
- **Google Mock (GMock)** - Mock 对象框架

### 测试覆盖率类型
- **语句覆盖** - 覆盖每一行可执行代码
- **分支覆盖** - 覆盖所有条件分支
- **函数覆盖** - 覆盖所有函数

### Mock 对象使用
使用 MockStorage 模拟存储层，隔离测试对象：
```cpp
class MockStorage : public IStorage {
public:
    MOCK_METHOD(bool, save, (const std::string& key, const std::string& data), (override));
    MOCK_METHOD(std::string, load, (const std::string& key), (override));
    MOCK_METHOD(bool, remove, (const std::string& key), (override));
    MOCK_METHOD(bool, exists, (const std::string& key), (const, override));
};
```

### 测试策略
1. **单元测试** - 测试每个类的独立功能
2. **边界值测试** - 测试边界条件（零、负数、极大值、空字符串）
3. **异常测试** - 测试错误处理机制
4. **集成测试** - 测试模块间协作
5. **业务场景测试** - 模拟真实使用场景

## 📁 文件清单

```
Software-Engineering/
├── CMakeLists.txt                          # CMake构建配置
├── .github/workflows/ci.yml                # GitHub Actions CI配置
├── README.md                               # 本文档
├── run_tests.ps1                           # PowerShell测试脚本
│
├── tests/                                  # 测试代码目录
│   ├── test_transaction_repository.cpp     # TransactionRepository单元测试
│   ├── test_statistics_service.cpp         # StatisticsService单元测试
│   ├── test_integration.cpp                # 集成测试
│   └── fuzz_target.cpp                     # 模糊测试目标（可选）
│
├── include/                                # 头文件
│   ├── models/
│   ├── services/
│   ├── storage/
│   └── controller/
│
└── src/                                    # 源文件
    ├── main.cpp
    ├── FileStorage.cpp
    ├── TransactionRepository.cpp
    ├── StatisticsService.cpp
    └── ...
```

## ⚙️ GitHub Actions CI 配置说明

配置文件位于 `.github/workflows/ci.yml`，包含以下步骤：

1. **代码检出** - 从GitHub仓库拉取代码
2. **安装依赖** - 安装CMake、GCC、lcov
3. **配置CMake** - 配置构建系统
4. **编译项目** - 多核并行编译
5. **运行单元测试** - TransactionRepository + StatisticsService
6. **运行集成测试** - 完整业务场景测试
7. **发布测试结果** - 生成测试报告
8. **生成覆盖率** - lcov代码覆盖率分析
9. **上传覆盖率** - 上传到Codecov平台

触发条件：
- 推送到 main/master 分支
- 创建 Pull Request

## 🛠️ 技术栈

- **语言**: C++17
- **构建工具**: CMake 3.14+
- **测试框架**: Google Test 1.12.1
- **Mock框架**: Google Mock
- **覆盖率工具**: lcov (Linux)
- **CI/CD**: GitHub Actions

## 📝 注意事项

1. **Windows用户**: 需要安装Visual Studio或MinGW
2. **Linux用户**: 需要安装g++和CMake
3. **覆盖率分析**: 仅在Linux平台支持lcov
4. **测试独立性**: 每个测试用例独立运行，互不影响

## 许可证

本项目仅用于学习和演示。

## 主要特性

✓ **交易管理**: 添加、编辑、删除、查询交易
✓ **数据统计**: 月度统计、分类分析、资产趋势
✓ **预算提醒**: 支持设置月度预算和阈值提醒
✓ **数据导入导出**: JSON和CSV格式
✓ **数据持久化**: 基于文件系统的存储
✓ **事件通知**: 异步通知机制

## 设计模式应用

- **Repository Pattern**: TransactionRepository 提供数据访问抽象
- **Service Layer Pattern**: 业务逻辑与数据访问分离
- **Dependency Injection**: 通过构造函数注入依赖
- **Observer Pattern**: NotificationService 的监听机制
- **Factory Pattern**: 数据生成和转换
- **Strategy Pattern**: 多种导出策略

## 时序流程

### 新增交易流程
1. 用户在UI输入交易数据
2. Controller 接收请求，调用 Service 验证
3. Service 转换为 Transaction 实体，调用 Repository 保存
4. Repository 调用 IStorage 持久化
5. Service 触发 StatisticsService 更新统计
6. Service 触发 NotificationService 检查阈值
7. 结果返回给 Controller，展示给用户

## 数据存储

所有数据存储在 `data/` 目录下的JSON文件中：
- `transactions.json`: 所有交易记录
- 其他配置文件（可扩展）

## 扩展点

1. **数据库支持**: 可以实现 `IStorage` 接口，支持SQLite/MySQL
2. **UI界面**: 可以添加Qt或者Web前端
3. **图表展示**: 集成图表库进行数据可视化
4. **数据加密**: 添加加密功能保护敏感数据
5. **多用户支持**: 添加用户认证和隔离

## 系统架构图

```
┌─────────────────┐
│   Main Entry    │
└────────┬────────┘
         │
┌────────▼───────────────────────────────────┐
│     TransactionController                   │
│  (统一入口，协调各个服务)                    │
└────────┬────────────┬──────────┬───────────┘
         │            │          │
    ┌────▼──┐    ┌───▼────┐    └─►NotificationService
    │Stats  │    │Import  │
    │Service│    │Export  │
    └────┬──┘    │Service │
         │       └────┬────┘
         └────┬────────┤
              │        │
         ┌────▼────────▼──────────────┐
         │ TransactionRepository       │
         │ (数据访问层)                │
         └────┬─────────────────────┘
              │
         ┌────▼──────────────┐
         │  IStorage          │
         │  (存储接口)        │
         └────┬──────────────┘
              │
         ┌────▼──────────────┐
         │ FileStorage        │
         │ (文件存储实现)     │
         └────────────────────┘
```

## 🧪 测试框架

### 测试统计
- **单元测试用例：** 36个
  - TransactionRepository: 16个
  - StatisticsService: 20个
- **集成测试用例：** 6个
- **代码覆盖率：** >89%（语句覆盖率）
- **测试框架：** Google Test + Google Mock

### 快速运行测试

**Linux/Mac:**
```bash
chmod +x run_tests.sh
./run_tests.sh
```

**Windows PowerShell:**
```powershell
.\run_tests.ps1
```

**手动运行:**
```bash
mkdir build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Debug
cmake --build .

# 运行测试
./test_transaction_repository
./test_statistics_service
./test_integration
```

### 生成覆盖率报告

```bash
cd build_coverage
cmake .. -DCMAKE_BUILD_TYPE=Coverage
cmake --build .
./test_transaction_repository
./test_statistics_service
./test_integration

lcov --capture --directory . --output-file coverage.info
lcov --remove coverage.info '/usr/*' '*/tests/*' --output-file coverage_filtered.info
genhtml coverage_filtered.info --output-directory coverage_report
```

## 🔍 模糊测试

使用 AFL++ 进行模糊测试：

```bash
# 编译模糊测试目标
./build_fuzz.sh

# 运行AFL++
cd build_fuzz
mkdir -p ../fuzz_input ../fuzz_output
echo "test" > ../fuzz_input/seed.txt
afl-fuzz -i ../fuzz_input -o ../fuzz_output ./fuzz_target @@
```

详细说明请参考 [FUZZING_GUIDE.md](FUZZING_GUIDE.md)

## 🚀 持续集成

项目配置了 GitHub Actions CI，每次推送代码自动执行：
1. 编译项目
2. 运行所有单元测试
3. 运行集成测试
4. 生成代码覆盖率报告
5. 上传到 Codecov

配置文件：`.github/workflows/ci.yml`

## 📚 文档

- [TEST_GUIDE.md](TEST_GUIDE.md) - 测试指南和报告模板
- [FUZZING_GUIDE.md](FUZZING_GUIDE.md) - 模糊测试详细教程
- [experiment_report.md](experiment_report.md) - 实验报告

## 🛠️ 技术栈

- **语言：** C++17
- **构建工具：** CMake 3.14+
- **测试框架：** Google Test 1.12.1
- **Mock框架：** Google Mock
- **覆盖率工具：** lcov
- **模糊测试：** AFL++
- **CI/CD：** GitHub Actions

## 📋 实验要求完成情况

- [x] **单元测试** - 2个子功能，各16+测试用例，覆盖率>80%
- [x] **集成测试** - 2组集成测试，验证模块协作
- [x] **模糊测试** - AFL++配置和运行
- [x] **持续集成** - GitHub Actions自动化测试
- [x] **缺陷修复** - AI辅助修复至少3个缺陷

## 许可证

此项目为学习和演示用途。




